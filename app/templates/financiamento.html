{% extends 'base.html' %}
{% load static %}

{% block title %}Simulação de Financiamento | {{ carro.marca }} {{ carro.modelo }}{% endblock %}

{% block extra_css %}
<style>
  .fin-card {
    max-width: 900px;
    margin: 2.2rem auto;
    padding: 1.6rem;
    border-radius: 12px;
    background: #fff;
    box-shadow: 0 6px 20px rgba(0,0,0,0.06);
  }
  .big-parcela {
    font-size: 1.9rem;
    font-weight: 800;
    color: #0d6efd;
    text-align:center;
  }
  .highlight-box {
    padding: 1rem;
    border-radius: 10px;
    background: #f8f9fa;
    margin-top: 1rem;
  }
  .quick-buttons { display:flex; gap:0.5rem; flex-wrap:wrap; margin-top:0.6rem; }
  .quick-entry {
    padding:0.45rem 0.8rem;
    border-radius:8px;
    border:1px solid #ced4da;
    background:#f8f9fa;
    cursor:pointer;
    font-weight:600;
  }
  .quick-entry.disabled { opacity:0.45; cursor:not-allowed; }
  .compare-cards { display:flex; gap:0.8rem; margin-top:0.9rem; flex-wrap:wrap; justify-content:center; }
  .compare-card {
    min-width:150px;
    padding:0.8rem;
    border-radius:10px;
    background:#f8f9fa;
    text-align:center;
    box-shadow:0 6px 12px rgba(0,0,0,0.02);
  }
  .compare-card.best { border:2px solid #198754; background:#e9f7ef; }
  .muted { color:#6c757d; font-size:0.95rem; }
  .btn-primary-custom {
    display:block;
    width:100%;
    padding:0.65rem;
    border-radius:8px;
    background:#198754;
    color:#fff;
    border:none;
    font-weight:700;
  }
  details p { margin:0.4rem 0; }
</style>
{% endblock %}

{% block content %}
<div class="fin-card">
  <h3>{{ carro.marca }} {{ carro.modelo }} {{ carro.ano }}</h3>
  <p><strong>Preço do veículo:</strong> R$ {{ carro.valor|floatformat:2 }}</p>

  <form id="simulador-form">
    <div class="mb-3">
      <label for="parcelas" class="form-label">Escolha em quantas vezes deseja pagar:</label>
      <select id="parcelas" class="form-select">
        <option value="12">12x</option>
        <option value="24" selected>24x</option>
        <option value="36">36x</option>
        <option value="48">48x</option>
        <option value="60">60x</option>
      </select>
    </div>

    <div class="mb-3">
      <label for="entrada" class="form-label">Valor de entrada (quanto vai dar de início):</label>
      <input id="entrada" type="number" class="form-control" min="0" step="1" value="0" />
      <div class="quick-buttons" id="quickButtons"></div>
    </div>

    <button id="btnCalcular" type="submit" class="btn-primary-custom">Calcular Parcela</button>
    <div id="msgErro" style="display:none;margin-top:0.6rem;color:#b02a37;font-weight:600;"></div>
  </form>

  <div id="resultado" class="highlight-box" style="display:none;">
    <h5 class="text-center">Resultado da Simulação</h5>
    <p class="big-parcela" id="parcela-texto">—</p>
    <p class="text-center muted">Parcela fixa ao mês (juros inclusos)</p>

    <details>
      <summary style="cursor:pointer;">Clique para ver detalhes do financiamento</summary>
      <div style="margin-top:0.6rem;">
        <p><strong>Valor financiado:</strong> quanto será parcelado → <span id="valor-financiado"></span></p>
        <p><strong>Total de juros:</strong> custo do financiamento ao longo do período → <span id="total-juros"></span></p>
        <p><strong>Total pago:</strong> soma de todas as parcelas (entrada + financiamento) → <span id="total-pago"></span></p>
        <p><strong>Taxa de juros aplicada:</strong> <span id="taxa-detalhe">1,5% ao mês</span></p>
      </div>
    </details>

    <div id="compareSection" style="margin-top:1rem;">
      <h6 class="text-center">Compare diferentes valores de entrada</h6>
      <div class="compare-cards" id="compareCards"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const taxa = 0.015; // 1.5% ao mês
  const valorCarro = Number("{{ carro.valor|floatformat:2 }}".replace(',', '.'));

  function formatBR(value) {
    return Number(value).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  }

  function calcularPrice(valor, taxa, n) {
    if (taxa === 0) return valor / n;
    return (valor * taxa) / (1 - Math.pow(1 + taxa, -n));
  }

  function atualizarSimulacao(entrada, parcelas) {
    if (entrada >= valorCarro) {
      document.getElementById('msgErro').style.display = 'block';
      document.getElementById('msgErro').innerText = "A entrada não pode ser maior ou igual ao valor do carro.";
      return;
    }
    document.getElementById('msgErro').style.display = 'none';

    const valorFinanciado = valorCarro - entrada;
    const parcela = calcularPrice(valorFinanciado, taxa, parcelas);
    const totalPago = parcela * parcelas;
    const totalJuros = totalPago - valorFinanciado;

    document.getElementById('parcela-texto').innerText = formatBR(parcela);
    document.getElementById('valor-financiado').innerText = formatBR(valorFinanciado);
    document.getElementById('total-juros').innerText = formatBR(totalJuros);
    document.getElementById('total-pago').innerText = formatBR(totalPago);

    document.getElementById('resultado').style.display = 'block';

    // Comparativo com diferentes entradas
    const entradas = [0, 10000, 20000, 30000];
    const compareDiv = document.getElementById('compareCards');
    compareDiv.innerHTML = "";
    entradas.forEach(val => {
      if (val < valorCarro) {
        const parcelaAlt = calcularPrice(valorCarro - val, taxa, parcelas);
        const card = document.createElement('div');
        card.className = "compare-card";
        card.innerHTML = `
          <p><strong>Entrada:</strong> ${formatBR(val)}</p>
          <p><strong>Parcela:</strong> ${formatBR(parcelaAlt)}</p>
          <p class="muted">em ${parcelas}x</p>
        `;
        compareDiv.appendChild(card);
      }
    });
  }

  document.getElementById('simulador-form').addEventListener('submit', e => {
    e.preventDefault();
    const entrada = parseFloat(document.getElementById('entrada').value) || 0;
    const parcelas = parseInt(document.getElementById('parcelas').value);
    atualizarSimulacao(entrada, parcelas);
  });

  // Botões rápidos de entrada
  const quickDiv = document.getElementById('quickButtons');
  [0, valorCarro*0.10, valorCarro*0.20, valorCarro*0.30].forEach(val => {
if (val < valorCarro) {
  const btn = document.createElement('div');
  btn.className = "quick-entry";

  if (val === 0) {
    btn.innerText = "Sem entrada";
  } else if (val === valorCarro * 0.10) {
    btn.innerText = "10% do valor do veículo";
  } else if (val === valorCarro * 0.20) {
    btn.innerText = "20% do valor do veículo";
  } else if (val === valorCarro * 0.30) {
    btn.innerText = "30% do valor do veículo";
  } else {
    btn.innerText = formatBR(val);
  }

  btn.addEventListener('click', () => {
    document.getElementById('entrada').value = val;
  });

  quickDiv.appendChild(btn);
}

  });
</script>
{% endblock %}
