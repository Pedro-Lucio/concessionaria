{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">Listas</h1>

        <!-- Ações: apenas uma aparece por vez (controlado por JS) -->
        <div id="acoesListas" class="d-flex gap-2">
            <a id="btnNovoFuncionario" href="{% url 'criar_funcionario' %}" class="btn btn-primary d-none" aria-hidden="true">
                <i class="fas fa-plus me-1"></i> Novo funcionário
            </a>
            <a id="btnNovoCarro" href="{% url 'criar_carro' %}" class="btn btn-primary d-none" aria-hidden="true">
                <i class="fas fa-plus me-1"></i> Novo carro
            </a>
            <!-- NOVO BOTÃO PARA VENDAS -->
            <a id="btnNovaVenda" href="{% url 'salvar_venda' %}" class="btn btn-primary d-none" aria-hidden="true">
                <i class="fas fa-plus me-1"></i> Nova venda
            </a>
        </div>
    </div>

    <!-- Menu de abas -->
    <nav class="mb-3" aria-label="Abas de listas">
        <ul class="nav nav-pills" id="listasTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <a class="nav-link active" href="#funcionarios" data-target="funcionarios" role="tab">
                    <i class="fas fa-users me-1"></i> Funcionários
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" href="#clientes" data-target="clientes" role="tab">
                    <i class="fas fa-user-tie me-1"></i> Clientes
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" href="#carros" data-target="carros" role="tab">
                    <i class="fas fa-car me-1"></i> Carros Inativos
                </a>
            </li>
            <!-- NOVA ABA VENDAS -->
            <li class="nav-item" role="presentation">
                <a class="nav-link" href="#vendas" data-target="vendas" role="tab">
                    <i class="fas fa-shopping-cart me-1"></i> Vendas
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" href="#historico" data-target="historico" role="tab">
                    <i class="fas fa-history me-1"></i> Histórico de Alterações
                </a>
            </li>
        </ul>
    </nav>

    <!-- Conteúdo das abas -->
    <div id="tabContent">
        <!-- Funcionários -->
        <div id="funcionarios" class="tab-pane active">
            <div class="card shadow-sm mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <strong><i class="fas fa-users me-1"></i> Funcionários</strong>
                        <span class="badge bg-secondary ms-2">{{ funcionarios|length }}</span>
                    </div>
                </div>

                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Nome</th>
                                    <th>Usuário</th>
                                    <th>Telefone</th>
                                    <th>Admissão</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for f in funcionarios %}
                                <tr>
                                    <td>{{ f.nome|default:"—" }}</td>
                                    <td>{{ f.user.username|default:"—" }}</td>
                                    <td>{{ f.telefone|default:"—" }}</td>
                                    <td>
                                        {% if f.data_admissao %}
                                            {{ f.data_admissao|date:"d/m/Y" }}
                                        {% else %}
                                            —
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if f.pk %}
                                        <a href="{% url 'editar_funcionario' f.pk %}" class="btn btn-primary btn-sm">
                                            <i class="fas fa-edit me-1"></i> Editar
                                        </a>
                                        {% else %}
                                        <button class="btn btn-secondary btn-sm" disabled title="ID inválido">
                                            <i class="fas fa-edit me-1"></i> Editar
                                        </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-muted text-center py-3">
                                        <i class="fas fa-info-circle me-1"></i> Nenhum funcionário cadastrado.
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Clientes -->
        <div id="clientes" class="tab-pane d-none">
            <div class="card shadow-sm mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <strong><i class="fas fa-user-tie me-1"></i> Clientes</strong>
                        <span class="badge bg-secondary ms-2">{{ clientes|length }}</span>
                    </div>
                </div>

                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Nome</th>
                                    <th>Usuário</th>
                                    <th>E-mail</th>
                                    <th>Telefone</th>
                                    <th>Kgs Doados</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for c in clientes %}
                                <tr>
                                    <td>{{ c.nome|default:"—" }}</td>
                                    <td>{{ c.user.username|default:"—" }}</td>
                                    <td>{{ c.email|default:"—" }}</td>
                                    <td>{{ c.telefone|default:"—" }}</td>
                                    <td>{{ c.kgs_borracha_doados|floatformat:2|default:"—" }}</td>
                                    <td class="text-center">
                                        {% if c.pk %}
                                        <a href="{% url 'editar_cliente' c.pk %}" class="btn btn-primary btn-sm">
                                            <i class="fas fa-edit me-1"></i> Editar
                                        </a>
                                        {% else %}
                                        <button class="btn btn-secondary btn-sm" disabled title="ID inválido">
                                            <i class="fas fa-edit me-1"></i> Editar
                                        </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-muted text-center py-3">
                                        <i class="fas fa-info-circle me-1"></i> Nenhum cliente cadastrado.
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Carros Inativos -->
        <div id="carros" class="tab-pane d-none">
            <div class="card shadow-sm mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <strong><i class="fas fa-car me-1"></i> Carros inativos</strong>
                        <span class="badge bg-secondary ms-2">{{ carros_inativos|length }}</span>
                    </div>
                </div>

                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Carro</th>
                                    <th>Ano</th>
                                    <th>Marca</th>
                                    <th>Valor</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for carro in carros_inativos %}
                                <tr>
                                    <td>{{ carro.marca }} {{ carro.modelo|default:"—" }}</td>
                                    <td>{{ carro.ano|default:"—" }}</td>
                                    <td>{{ carro.marca|default:"—" }}</td>
                                    <td>R$ {{ carro.valor|default:"—" }}</td>
                                    <td class="text-center">
                                        <a href="{% url 'detalhes' carro.id %}" class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-eye me-1"></i> Ver
                                        </a>
                                        <form action="{% url 'listas' %}" method="post" class="d-inline">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="reativar">
                                            <input type="hidden" name="carro_id" value="{{ carro.id }}">
                                            <button type="submit" class="btn btn-success btn-sm">
                                                <i class="fas fa-redo me-1"></i> Reativar
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-muted text-center py-3">
                                        <i class="fas fa-info-circle me-1"></i> Nenhum carro inativo.
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- NOVA ABA: VENDAS -->
        <div id="vendas" class="tab-pane d-none">
            <div class="card shadow-sm mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <strong><i class="fas fa-shopping-cart me-1"></i> Vendas</strong>
                        <span class="badge bg-secondary ms-2">{{ vendas|length }}</span>
                    </div>
                </div>

                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Carro</th>
                                    <th>Cliente</th>
                                    <th>Vendedor</th>
                                    <th>Data</th>
                                    <th>Valor</th>
                                    <th>Pagamento</th>
                                    <th>Parcelas</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for venda in vendas %}
                                <tr>
                                    <td>#{{ venda.id }}</td>
                                    <td>
                                        {% if venda.carro %}
                                        <a href="{% url 'detalhes' venda.carro.id %}" class="text-decoration-none">
                                            {{ venda.carro.marca }} {{ venda.carro.modelo|default:"—" }}
                                        </a>
                                        {% else %}
                                        —
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if venda.cliente %}
                                            {{ venda.cliente.nome|default:venda.cliente.user.username }}
                                        {% else %}
                                            —
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if venda.vendedor %}
                                            {{ venda.vendedor.nome|default:venda.vendedor.user.username }}
                                        {% else %}
                                            —
                                        {% endif %}
                                    </td>
                                    <td>{{ venda.data_venda|date:"d/m/Y H:i"|default:"—" }}</td>
                                    <td>R$ {{ venda.valor_venda|floatformat:2|default:"0.00" }}</td>
                                    <td>
                                        <span class="badge bg-info">{{ venda.forma_pagamento|default:"—" }}</span>
                                    </td>
                                    <td>
                                        {% if venda.parcelas %}
                                            {{ venda.parcelas }}x
                                        {% else %}
                                            —
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <button class="btn btn-outline-info btn-sm" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#modalObservacoes{{ venda.id }}">
                                            <i class="fas fa-eye me-1"></i> Ver Obs.
                                        </button>
                                    </td>
                                </tr>

                                <!-- Modal para Observações -->
                                <div class="modal fade" id="modalObservacoes{{ venda.id }}" tabindex="-1">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Observações da Venda #{{ venda.id }}</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            <div class="modal-body">
                                                {% if venda.observacoes %}
                                                    {{ venda.observacoes|linebreaks }}
                                                {% else %}
                                                    <p class="text-muted">Nenhuma observação registrada.</p>
                                                {% endif %}
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <tr>
                                    <td colspan="9" class="text-muted text-center py-3">
                                        <i class="fas fa-info-circle me-1"></i> Nenhuma venda registrada.
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Histórico de Alterações -->
        <div id="historico" class="tab-pane d-none">
            <div class="card shadow-sm mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <strong><i class="fas fa-history me-1"></i> Histórico de Alterações</strong>
                        <span class="badge bg-secondary ms-2">{{ historico_alteracoes|length }}</span>
                    </div>
                </div>

                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Usuário</th>
                                    <th>Carro</th>
                                    <th>Campo Alterado</th>
                                    <th>Valor Antigo</th>
                                    <th>Valor Novo</th>
                                    <th>IP</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for alteracao in historico_alteracoes %}
                                <tr>
                                    <td>{{ alteracao.data_alteracao|date:"d/m/Y H:i"|default:"—" }}</td>
                                    <td>{{ alteracao.usuario.username|default:"—" }}</td>
                                    <td>
                                        {% if alteracao.carro %}
                                        <a href="{% url 'detalhes' alteracao.carro.id %}" class="text-decoration-none">
                                            {{ alteracao.carro.marca }} {{ alteracao.carro.modelo|default:"—" }}
                                        </a>
                                        {% else %}
                                        —
                                        {% endif %}
                                    </td>
                                    <td><span class="badge bg-secondary">{{ alteracao.campo_alterado|default:"—" }}</span></td>
                                    <td><span class="text-danger">{{ alteracao.valor_antigo|default:"—" }}</span></td>
                                    <td><span class="text-success">{{ alteracao.valor_novo|default:"—" }}</span></td>
                                    <td><small class="text-muted">{{ alteracao.ip_address|default:"—" }}</small></td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-muted text-center py-3">
                                        <i class="fas fa-info-circle me-1"></i> Nenhum registro de alteração encontrado.
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JS para alternância de abas + controle de qual botão exibir -->
<script>
(function () {
    const links = document.querySelectorAll('#listasTabs a.nav-link');
    const panes = {
        funcionarios: document.getElementById('funcionarios'),
        clientes: document.getElementById('clientes'),
        carros: document.getElementById('carros'),
        vendas: document.getElementById('vendas'), // NOVO
        historico: document.getElementById('historico')
    };
    const btnFuncionario = document.getElementById('btnNovoFuncionario');
    const btnCarro = document.getElementById('btnNovoCarro');
    const btnVenda = document.getElementById('btnNovaVenda'); // NOVO

    function hideAll() {
        Object.values(panes).forEach(p => {
            if (p) {
                p.classList.add('d-none');
                p.classList.remove('active');
            }
        });
        links.forEach(l => l.classList.remove('active'));
    }

    function showTab(name) {
        if (!panes[name]) return;
        hideAll();
        panes[name].classList.remove('d-none');
        panes[name].classList.add('active');

        const activeLink = document.querySelector('#listasTabs a[data-target="' + name + '"]');
        if (activeLink) activeLink.classList.add('active');

        // atualizar hash sem criar histórico extra
        try { history.replaceState(null, '', '#' + name); } catch (e) {}

        // controlar visibilidade dos botões (se existirem)
        if (btnFuncionario) btnFuncionario.classList.add('d-none');
        if (btnCarro) btnCarro.classList.add('d-none');
        if (btnVenda) btnVenda.classList.add('d-none'); // NOVO

        if (name === 'funcionarios' && btnFuncionario) {
            btnFuncionario.classList.remove('d-none');
            btnFuncionario.removeAttribute('aria-hidden');
        } else if (name === 'carros' && btnCarro) {
            btnCarro.classList.remove('d-none');
            btnCarro.removeAttribute('aria-hidden');
        } else if (name === 'vendas' && btnVenda) { // NOVO
            btnVenda.classList.remove('d-none');
            btnVenda.removeAttribute('aria-hidden');
        }
    }

    // clique nos links
    links.forEach(a => {
        a.addEventListener('click', function (e) {
            e.preventDefault();
            showTab(this.getAttribute('data-target'));
        });
    });

    // inicializar conforme hash ou por padrão em funcionários
    const hash = window.location.hash.replace('#', '');
    if (hash && panes[hash]) {
        showTab(hash);
    } else {
        showTab('funcionarios');
    }
})();
</script>
{% endblock %}