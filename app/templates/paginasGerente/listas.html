{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">Listas</h1>

        <!-- Botões: apenas um ficará visível por vez -->
        <div id="acoesListas">
            <a id="btnNovoFuncionario" href="{% url 'criar_funcionario' %}" class="btn btn-primary"
                style="display:none;">
                + Novo funcionário
            </a>
            <a id="btnNovoCarro" href="{% url 'criar_carro' %}" class="btn btn-primary" style="display:none;">
                + Novo carro
            </a>
        </div>
    </div>

    <!-- Menu de abas simples -->
    <nav class="mb-3">
        <ul class="nav nav-pills" id="listasTabs">
            <li class="nav-item">
                <a class="nav-link active" href="#funcionarios" data-target="funcionarios">Funcionários</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#clientes" data-target="clientes">Clientes</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#carros" data-target="carros">Carros Inativos</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#historico" data-target="historico">Histórico de Alterações</a>
            </li>
        </ul>
    </nav>

    <!-- Conteúdo das abas -->
    <div id="tabContent">
        <!-- Funcionários -->
        <div id="funcionarios" class="tab-pane active">
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <strong>Funcionários</strong>
                    <span class="text-muted ms-2">({{ funcionarios|length }})</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Usuário</th>
                                    <th>Telefone</th>
                                    <th>Admissão</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for f in funcionarios %}
                                <tr>
                                    <td>{{ f.nome }}</td>
                                    <td>{{ f.user.username }}</td>
                                    <td>{{ f.telefone|default:"—" }}</td>
                                    <td>{% if f.data_admissao %}{{ f.data_admissao|date:"d/m/Y" }}{% else %}—{% endif %}
                                    </td>
                                    <td>
                                        {% if f.pk %}
                                        <a href="{% url 'editar_funcionario' f.pk %}" class="btn btn-primary btn-sm">
                                            <i class="fas fa-edit"></i> Editar
                                        </a>
                                        {% else %}
                                        <button class="btn btn-secondary btn-sm" disabled title="ID inválido">
                                            <i class="fas fa-edit"></i> Editar
                                        </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-muted">Nenhum funcionário cadastrado.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>


        <!-- Clientes -->
        <div id="clientes" class="tab-pane">
                <div class="card shadow-sm mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Clientes</strong>
                            <span class="text-muted ms-2">({{ clientes|length }})</span>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm mb-0">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Usuário</th>
                                        <th>Telefone</th>
                                        <th>E-mail</th>
                                        <th>Kgs Doados</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for c in clientes %}
                                    <tr>
                                        <td>{{ c.nome }}</td>
                                        <td>{{ c.user.username }}</td>
                                        <td>{{ c.telefone|default:"—" }}</td>
                                        <td>{{ c.email|default:"—" }}</td>
                                        <td>
                                            <span class="badge bg-success">
                                                {{ c.kgs_borracha_doados }} kg
                                            </span>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="{% url 'editar_cliente' c.pk %}" class="btn btn-info" title="Editar Kgs Doados">
                                                    <i class="fas fa-weight"></i>
                                                </a>
                                                <a href="#" class="btn btn-outline-info" title="Detalhes">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="6" class="text-muted text-center py-3">
                                            <i class="fas fa-users fa-2x mb-2 d-block"></i>
                                            Nenhum cliente cadastrado.
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        <!-- Carros Inativos -->
        <div id="carros" class="tab-pane" style="display:none;">
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <strong>Carros inativos</strong>
                    <span class="text-muted ms-2">({{ carros_inativos|length }})</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>Carro</th>
                                    <th>Ano</th>
                                    <th>Marca</th>
                                    <th>Valor</th>
                                    <th class="text-end">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for carro in carros_inativos %}
                                <tr>
                                    <td>{{ carro.marca }} {{ carro.modelo }}</td>
                                    <td>{{ carro.ano }}</td>
                                    <td>{{ carro.marca }}</td>
                                    <td>R$ {{ carro.valor }}</td>
                                    <td class="text-end">
                                        <a href="{% url 'detalhes' carro.id %}"
                                            class="btn btn-sm btn-outline-secondary">Ver</a>
                                        <form action="{% url 'listas' %}" method="post" style="display:inline;">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="reativar">
                                            <input type="hidden" name="carro_id" value="{{ carro.id }}">
                                            <button type="submit" class="btn btn-sm btn-success">Reativar</button>
                                        </form>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-muted">Nenhum carro inativo.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Nova Aba: Histórico de Alterações -->
        <div id="historico" class="tab-pane" style="display:none;">
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <strong>Histórico de Alterações</strong>
                    <span class="text-muted ms-2">({{ historico_alteracoes|length }} registros)</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Usuário</th>
                                    <th>Carro</th>
                                    <th>Campo Alterado</th>
                                    <th>Valor Antigo</th>
                                    <th>Valor Novo</th>
                                    <th>IP</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for alteracao in historico_alteracoes %}
                                <tr>
                                    <td>{{ alteracao.data_alteracao|date:"d/m/Y H:i" }}</td>
                                    <td>{{ alteracao.usuario.username }}</td>
                                    <td>
                                        <a href="{% url 'detalhes' alteracao.carro.id %}" class="text-decoration-none">
                                            {{ alteracao.carro.marca }} {{ alteracao.carro.modelo }}
                                        </a>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ alteracao.campo_alterado }}</span>
                                    </td>
                                    <td>
                                        <span class="text-danger">{{ alteracao.valor_antigo|default:"—" }}</span>
                                    </td>
                                    <td>
                                        <span class="text-success">{{ alteracao.valor_novo|default:"—" }}</span>
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ alteracao.ip_address|default:"—" }}</small>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-muted text-center py-3">
                                        Nenhum registro de alteração encontrado.
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- JS para alternância de abas + controle de qual botão exibir -->
<script>
    (function () {
        const links = document.querySelectorAll('#listasTabs a.nav-link');
        const panes = {
            funcionarios: document.getElementById('funcionarios'),
            carros: document.getElementById('carros'),
            historico: document.getElementById('historico')
        };
        const btnFuncionario = document.getElementById('btnNovoFuncionario');
        const btnCarro = document.getElementById('btnNovoCarro');

        function showTab(name) {
            // esconder todos os painéis
            Object.values(panes).forEach(p => { p.style.display = 'none'; p.classList.remove('active'); });
            // remover active dos links
            links.forEach(l => l.classList.remove('active'));
            // mostrar o selecionado
            panes[name].style.display = '';
            panes[name].classList.add('active');
            // ativar link correspondente
            const activeLink = document.querySelector('#listasTabs a[data-target="' + name + '"]');
            if (activeLink) activeLink.classList.add('active');
            // atualizar hash sem criar histórico extra
            history.replaceState(null, '', '#' + name);

            // controlar visibilidade dos botões
            if (name === 'funcionarios') {
                btnFuncionario.style.display = '';
                btnCarro.style.display = 'none';
            } else if (name === 'carros') {
                btnFuncionario.style.display = 'none';
                btnCarro.style.display = '';
            } else {
                // padrão: esconder ambos
                btnFuncionario.style.display = 'none';
                btnCarro.style.display = 'none';
            }
        }

        // clique nos links
        links.forEach(a => {
            a.addEventListener('click', function (e) {
                e.preventDefault();
                showTab(this.getAttribute('data-target'));
            });
        });

        // inicializar conforme hash ou por padrão em funcionários
        const hash = window.location.hash.replace('#', '');
        if (hash && panes[hash]) {
            showTab(hash);
        } else {
            showTab('funcionarios');
        }
    })();
</script>
{% endblock %}