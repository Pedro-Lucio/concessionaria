{% extends 'base.html' %}
{% block content %}
    <title>Assistente de Carros</title>
    <style>
.chat-container { max-width: 500px; margin: 40px auto; padding: 10px; background: #fefefe; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); font-family: Arial, sans-serif; }
.mensagens { display: flex; flex-direction: column; gap: 12px; max-height: 65vh; overflow-y: auto; padding-bottom: 10px; }
.bot { background: #eaf1ff; color: #000; padding: 12px 16px; border-radius: 18px; max-width: 75%; align-self: flex-start; }
.user { background: #0078ff; color: #fff; padding: 12px 16px; border-radius: 18px; max-width: 75%; align-self: flex-end; }
.opcoes { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
.opcoes button { flex: 1 1 auto; min-width: 120px; padding: 10px; border: none; border-radius: 12px; cursor: pointer; background: #0078ff; color: #fff; transition: 0.2s; }
.opcoes button:hover { background: #005ecb; }
.carro { background: #fff; border-radius: 10px; padding: 12px; margin-top: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }

.chat-header {
    background: linear-gradient(90deg, #005ecb, #81C784);
    color: white;
    padding: 20px;
    text-align: center;
    border-radius: 12px 12px 0 0;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    margin-bottom: 15px;
}

.chat-header h1 {
    margin: 0;
    font-size: 1.8em;
    font-weight: bold;
    line-height: 1.2;
}

.chat-header p {
    margin: 5px 0 0 0;
    font-size: 1em;
    opacity: 0.9;
}
</style>
    <div class="chat-container">
            <div class="chat-header">
                <h1>ðŸš— Descubra o carro que combina com vocÃª!</h1>
                <p>Responda algumas perguntas e eu vou te mostrar o carro mais prÃ³ximo do que vocÃª deseja!</p>
            </div>
        <div class="mensagens" id="mensagens">
            <!-- mensagens aparecerÃ£o aqui -->
        </div>
        <div class="opcoes" id="opcoes">
            <!-- botÃµes aparecerÃ£o aqui -->
        </div>
    </div>

    <script>
        let pergunta_atual_id = null;

        function carregarPergunta() {
            fetch("{% url 'assistente' %}")
            .then(res => res.json())
            .then(data => {
                mostrarPergunta(data);
            });
        }

        function mostrarPergunta(data) {
            pergunta_atual_id = data.id;
            const mensagens = document.getElementById("mensagens");
            mensagens.innerHTML += `<div class="bot">${data.pergunta}</div>`;

            const opcoesDiv = document.getElementById("opcoes");
            opcoesDiv.innerHTML = "";
            data.opcoes.forEach(op => {
                const btn = document.createElement("button");
                btn.className = "opcao-btn";
                btn.innerText = op;
                btn.onclick = () => enviarResposta(op);
                opcoesDiv.appendChild(btn);
            });

            mensagens.scrollTop = mensagens.scrollHeight;
        }

        function enviarResposta(resposta) {
            const mensagens = document.getElementById("mensagens");
            mensagens.innerHTML += `<div class="user">${resposta}</div>`;

            fetch("{% url 'assistente' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: `id=${pergunta_atual_id}&resposta=${resposta}`
            })
            .then(res => res.json())
            .then(data => {
                if (data.final) {
                    const opcoesDiv = document.getElementById("opcoes");
                    opcoesDiv.innerHTML = "";
                    if (data.carro) {
                        mensagens.innerHTML += `<div class="bot">ðŸ˜‰ Dentro do que vocÃª me contou, esse aqui Ã© o que mais combina com o seu perfil:</div>`;
                        mensagens.innerHTML += `<div class="carro">
                            <a href="${data.carro.url}"><b>${data.carro.nome}</b></a><br>${data.carro.valor}
                        </div>`;
                    } else {
                        mensagens.innerHTML += `<div class="bot">ðŸ˜… NÃ£o achei um carro que combine exatamente, mas podemos ajustar juntos! Que tal ver o nosso estoque completo?</div>`;
                    }
                } else {
                    mostrarPergunta(data);
                }
                mensagens.scrollTop = mensagens.scrollHeight;
            });
        }

        // iniciar o chat
        carregarPergunta();
    </script>
{% endblock %}